#!/bin/bash

set -e
echo "[*] Step 7: CVE Matching and Exploit Suggestions"

WORKDIR="results/step7_$(date +%Y-%m-%d_%H%M%S)"
mkdir -p "$WORKDIR"

# Check if Searchsploit is available
if ! command -v searchsploit &> /dev/null; then
    echo "[✗] searchsploit not found. Please install ExploitDB's tool first." >&2
    exit 1
fi

# Extract all fingerprints from nuclei and httpx JSONs
echo "[*] Extracting fingerprints from previous steps..."

# Consolidate CVEs or tech info
touch "$WORKDIR/tech_stack.txt"

find results/ -name "*.json" -exec grep -Eoi 'CVE-[0-9]{4}-[0-9]+' {} \; | sort -u >> "$WORKDIR/tech_stack.txt"
grep -Eo '"(server|technology|name|product)":"[^"]+"' results/*/* | cut -d':' -f2- | tr -d '"' | sort -u >> "$WORKDIR/tech_stack.txt"

# Run Searchsploit for each entry
echo "[*] Running Searchsploit for CVE and technology matches..."
while read -r term; do
    echo "[>] $term" >> "$WORKDIR/exploit_suggestions.txt"
    searchsploit "$term" >> "$WORKDIR/exploit_suggestions.txt" || true
    echo "-----------------------------" >> "$WORKDIR/exploit_suggestions.txt"
done < "$WORKDIR/tech_stack.txt"

echo "[✓] Step 7 completed. Output saved in $WORKDIR/exploit_suggestions.txt"
